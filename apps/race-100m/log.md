# GVRM 100m Race 実装ログ (Markdown 詳細版)

## 概要
- 本ドキュメントは `apps/race-100m` の実装内容・設計・操作方法・カスタマイズポイントをまとめた詳細ログです。
- 4レーン・100m の短距離走シーン。`assets` 内の GVRM モデルと FBX アニメーションを用いて、スタート〜ゴールまでのレースをレンダリングします。
- 追加要素: タイム計測、スコアボード、名前編集と永続化、PB(パーソナルベスト)保存、カウントダウン/ピストル音、フォトフィニッシュ風フラッシュ、カメラ自動追従(全レーン常時可視 + 最後尾注視)。

## 追加/変更ファイル
- `apps/race-100m/index.html` — UI/スタイル/インポートマップ/エントリHTML
- `apps/race-100m/main.js` — シーン構築・モデル/アニメ読み込み・レース進行ロジック・カメラ制御・UI連携
- `apps/race-100m/log.md` — 本ドキュメント

## 実行方法
1. ルートでHTTPサーバを起動
   - Python: `cd gaussian-vrm && python -m http.server 8080`
2. ブラウザで以下を開く
   - `http://localhost:8080/apps/race-100m/index.html`
3. CDN を利用するため、ネットワーク接続が必要です。

## 操作
- Start もしくは スペースキー: カウントダウン→スタート
- Reset: レース初期化
- Names: レーンの名前編集→保存 (localStorage に記録)
- スコアボード: レース中は順位/タイム、PB は名前単位で表示/管理

## アセット/依存
- モデル: `assets/sample6.gvrm`〜`sample9.gvrm`
- アニメ: `assets/Walking.fbx` (走行風表現のため `timeScale=2.2` で高速再生)
- ライブラリ
  - three.js (CDN)
  - @pixiv/three-vrm (CDN)
  - jszip (CDN)
  - gaussian-vrm.min.js, gaussian-splats-3d.module.js (リポジトリ同梱 `lib/`)

## シーン構成
- トラック: +Z 方向に 100m (`finishZ=100`)。スタート/フィニッシュラインとレーン境界を描画。
- レーン: 4本。X 位置は `[-4.5, -1.5, 1.5, 4.5]` を採用。
- ランナー: 各レーンに 1 体の GVRM を配置。`Walking.fbx` を高速再生し、実走風に見せています。
- 速度: 1 体ごとに `6.5〜8.7 m/s` の乱数。ゴール時はアニメ速度を減速 (`timeScale=0.6`) します。

## レース進行
- カウントダウン (3/2/1/GO!) 表示と同時に WebAudio でビープ音/ピストル音を再生
- スタート後、各ランナーは `z` 方向に速度 `speed * dt` で進行
- ゴール判定: `z >= 100` 到達でゴール。各自のフィニッシュタイムを記録
- 全員ゴール後、計時停止し PB を更新

## UI/永続化
- スコアボード: ランナー名、タイム、メダル(上位3名)、PB を表示
- Names 設定: `localStorage` キー `race100m:names` に保存（4名の配列）
- PB 保存: `localStorage` キー `race100m:pb` に保存（名前→PB秒数のマップ）

## サウンド設計 (WebAudio 合成)
- カウントダウン: Sine (660Hz/880Hz) 短パルス
- スタート: ホワイトノイズ + Bandpass + 短ディケイで擬似ピストル音
- 外部音源無しで動作、音量はマスターゲインで調整

## カメラ制御 (全レーン可視 + 最後尾注視)
- 目的: 4レーンすべてが常に視野に入り、かつ「最後尾ランナー」の周辺動作が見やすいフレーミング
- 手法:
  1. 横方向フィット: レーン幅から必要距離 `d` を算出
     - `d = (trackWidth/2 * margin) / (tan(vFov/2) * aspect)`
     - クランプ: `7〜16m` (近め・低めを維持)
  2. 注視対象: `focusZ = min(runners.z)` (最後尾ランナー)
  3. 先読み: `targetZ = focusZ + 2m` (最小限)
  4. 高さ: `targetY = max(5, d * 0.28)`
  5. カメラ位置: `(x=0, y=targetY, z=targetZ - d * 0.8)` を補間追従
- 結果: ランナーの動作が近接で見やすく、前を見過ぎない視点。全レーンは常に視野内。

## 主要コード位置
- エントリ: `apps/race-100m/index.html:1`
- レースロジック/描画: `apps/race-100m/main.js:1`
- ランナー読み込み: `apps/race-100m/main.js:58`
- 速度/アニメ設定: `apps/race-100m/main.js:76` `apps/race-100m/main.js:91`
- カメラ追従: `apps/race-100m/main.js:191` (`fitCameraToTrack`)
- Names/PB 永続化: `apps/race-100m/main.js:205` 以降
- サウンド: `apps/race-100m/main.js:238` 以降

## カスタマイズ例
- レーン/モデルの変更
  - `main.js` → `sources` を任意の `.gvrm` 配列に変更
  - レーン数を増やす場合、`lanes` と `laneColors` の要素を増やす
- 速度レンジの変更
  - `main.js` → `const speed = 6.5 + Math.random() * 2.2;` を調整
- ランニングFBXの使用
  - `Walking.fbx` を `Running.fbx` などに差し替え (assets に用意されている場合)
  - `timeScale` を適宜調整 (例: 1.2〜1.6)
- カメラの見え方を更に変更
  - `fitCameraToTrack()` 内の `look-ahead`、`d` クランプ、`targetY` 係数、補間速度を調整
- UI/演出
  - メダル表示のルール変更、ゴールテープ追加、スローモーション、写真判定ライン描画など

## 既知の制限/注意
- CDN 依存のためネットワークが必要
- 端末性能により描画負荷でフレームが落ちる場合あり（`renderer.setPixelRatio` の上限を下げるなどで緩和）
- PB は名前の文字列で紐付け。名前を変更すると新しい名前として扱われます

## 今後の発展案
- スタート反応時間のランダム化、False Start 判定
- レース履歴の保存/CSV エクスポート
- 可変レーン数・任意モデルのGUI選択
- WebXR 観戦モード
- 風向/勾配/疲労モデル等のシミュレーション導入

## 変更履歴 (ハイライト)
- v0.1 初期実装: 100m/4レーン、基本UI、D&D不要の自動進行
- v0.2 機能拡張: Names/PB 永続化、カウントダウン/ピストル音、フラッシュ演出
- v0.3 カメラ調整: 俯瞰→先頭寄り→最後尾注視・近接化で見やすさ改善（現在）

---
本ドキュメントに不足があればご指摘ください。用途に応じて更に詳細な設計情報（シーケンス/状態図/メモリ構造など）も追記可能です。

## プロンプト履歴 (原文そのまま)
- https://github.com/naruya/gaussian-vrm　このリポジトリを使ってassetsに入っている。モデルデータを使って100メートル競争を作って
- 実装して
- カメラの位置がわるいのか４レーンの全体の走っている人がみえない。
- 俯瞰してみえているのだけど。注目点がランナーより前すぎて走っている姿がみえない
- カメラの位置がまだまだランナーの走っている前をみてる。一番遅いランナーを見ているようにしてもっと手前にカメラをおいて
- 今やった内容をlog.txtで一旦出力して
- Markdown形式でもっと詳しく書いて
- ログにプロンプトも略さずにそのまま書いて
